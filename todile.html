<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>TNPSC Report Pro v4 (Tamil)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2225%22 fill=%22%234f46e5%22/><path d=%22M30 30 L70 30 L70 70 L30 70 Z%22 fill=%22none%22 stroke=%22white%22 stroke-width=%228%22/><path d=%22M50 30 L50 70 M30 50 L70 50%22 stroke=%22white%22 stroke-width=%228%22/></svg>">

    <style>
        :root {
            /* Modern Indigo/Violet Palette */
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --primary-dark: #3730a3;
            --secondary: #ec4899;
            
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.9);
            
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --nav-height: 75px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-glass: rgba(30, 41, 59, 0.95);
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border: #334155;
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s; }

        /* HEADER */
        header {
            height: 70px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-card); z-index: 10; border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .logo-container {
            display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.2rem; color: var(--primary);
        }
        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        
        .search-bar { flex: 1; margin: 0 15px; position: relative; max-width: 400px; }
        .search-input {
            width: 100%; background: var(--bg-body); border: 2px solid transparent; padding: 10px 12px 10px 40px;
            border-radius: 12px; font-family: inherit; font-size: 0.9rem; color: var(--text-main);
            transition: all 0.3s;
        }
        .search-input:focus { background: var(--bg-card); border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

        /* CONTAINER */
        #main-container { flex: 1; overflow-y: auto; padding: 20px 20px 110px 20px; scroll-behavior: smooth; }

        /* CARDS */
        .card {
            background: var(--bg-card); border-radius: 24px; padding: 24px; 
            box-shadow: var(--shadow); border: 1px solid var(--border);
            margin-bottom: 24px; position: relative; overflow: hidden;
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TIMER */
        .timer-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 25px; border-radius: 24px; text-align: center;
            margin-bottom: 24px; box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.4);
            position: relative; overflow: hidden;
        }
        .timer-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            pointer-events: none;
        }
        .timer-display { font-size: 3.5rem; font-weight: 800; margin: 15px 0; letter-spacing: 2px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); font-variant-numeric: tabular-nums; }
        
        .timer-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.1); color: white;
            padding: 10px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; margin: 0 6px;
            transition: all 0.2s; backdrop-filter: blur(5px);
        }
        .timer-btn:hover { background: rgba(255,255,255,0.35); transform: translateY(-2px); }
        .timer-btn:active { transform: translateY(0); }

        /* SCHEDULE BOX */
        .schedule-box {
            background: var(--bg-body); padding: 16px; border-radius: 16px; margin-bottom: 20px;
            display: flex; gap: 12px; flex-wrap: wrap; border: 1px solid var(--border);
        }
        .schedule-group { flex: 1; min-width: 130px; }
        .schedule-label { font-size: 0.75rem; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .schedule-input {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main); font-family: inherit; font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        .schedule-input:focus { border-color: var(--primary); }

        /* DYNAMIC TARGET LIST */
        .section-header-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .section-header {
            display: flex; align-items: center; gap: 10px;
            color: var(--primary); font-weight: 700; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;
        }
        .btn-add-target {
            background: var(--primary); color: white; border: none; padding: 8px 16px;
            border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;
        }
        .target-list {
            display: flex; flex-direction: column; gap: 12px;
        }
        .target-item {
            background: var(--bg-body); padding: 12px 16px; border-radius: 16px;
            border: 1px solid var(--border); transition: all 0.2s;
            display: flex; gap: 12px; align-items: center;
        }
        .target-item:hover { transform: translateX(2px); border-color: var(--primary-light); }
        .target-bullet {
            width: 10px; height: 10px; border-radius: 50%; background: var(--secondary); flex-shrink: 0;
        }
        .target-text {
            flex: 1; font-size: 0.95rem; line-height: 1.5; font-weight: 500; color: var(--text-main);
        }
        .target-delete {
            color: var(--text-sub); opacity: 0.5; cursor: pointer; padding: 5px;
        }
        .target-delete:hover { color: var(--danger); opacity: 1; }

        /* ANALYTICS */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { 
            background: var(--bg-body); padding: 20px; border-radius: 20px; text-align: center; 
            border: 1px solid var(--border); transition: transform 0.2s;
        }
        .stat-box:hover { transform: translateY(-3px); }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin-bottom: 5px; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-sub); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* DATA CONSOLE */
        .data-console {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            color: white; border: 1px solid #334155;
        }
        .console-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .console-btn {
            width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 12px; border: none;
            font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.2s;
        }
        .btn-backup { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .btn-backup:hover { background: rgba(59, 130, 246, 0.3); }
        .btn-import { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .btn-import:hover { background: rgba(16, 185, 129, 0.3); }

        /* NAV */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: var(--nav-height);
            background: var(--bg-glass); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 50;
            backdrop-filter: blur(10px); padding-bottom: 10px;
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            font-size: 0.75rem; color: var(--text-sub); font-weight: 600; padding: 10px 20px; 
            cursor: pointer; border: none; background: none; border-radius: 16px;
            transition: all 0.3s;
        }
        .nav-btn.active { color: var(--primary); background: rgba(79, 70, 229, 0.1); transform: translateY(-5px); }
        .nav-btn i { font-size: 1.3rem; margin-bottom: 2px; }

        /* MODAL & GRID */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 90; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; max-height: 50vh; overflow-y: auto; padding-right: 5px; }
        .grid-item {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; background: var(--bg-body); border: 1px solid var(--border);
            font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .grid-item.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .grid-item.done { border-color: var(--success); background: rgba(16,185,129,0.1); color: var(--success); }
        .grid-item.scheduled { border-bottom: 3px solid var(--warning); }
        
        .add-day-btn {
            grid-column: span 5;
            background: var(--bg-body); border: 2px dashed var(--primary); color: var(--primary);
            padding: 15px; border-radius: 12px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px;
            transition: all 0.2s;
        }
        .add-day-btn:hover { background: rgba(79, 70, 229, 0.05); }

        /* LIST ITEM */
        .list-item {
            background: var(--bg-card); padding: 18px; border-radius: 18px; margin-bottom: 14px;
            border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .list-item:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <header>
        <div class="logo-container" onclick="location.reload()">
            <div class="logo-icon"><i class="fas fa-bullseye"></i></div>
            <span>TNPSC Pro</span>
        </div>
        <div class="search-bar">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search..." oninput="handleSearch(this.value)">
        </div>
        <div style="width:40px; height:40px; border-radius:12px; background:var(--bg-body); display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-main); border:1px solid var(--border);" onclick="toggleTheme()">
            <i class="fas fa-moon"></i>
        </div>
    </header>

    <div id="main-container">
        
        <div id="view-home">
            
            <div class="timer-card">
                <div style="font-size:0.85rem; opacity:0.9; font-weight:700; text-transform:uppercase; letter-spacing:1.5px;">Session Stopwatch</div>
                <div class="timer-display" id="timer-display">00:00:00</div>
                <div>
                    <button class="timer-btn" onclick="startTimer()" id="btn-start"><i class="fas fa-play"></i> Start</button>
                    <button class="timer-btn" onclick="pauseTimer()"><i class="fas fa-pause"></i> Pause</button>
                    <button class="timer-btn" onclick="resetTimer()"><i class="fas fa-redo"></i> Reset</button>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding: 0 5px;">
                <span style="font-weight:800; font-size:1.3rem;">Day <span id="current-day-num" style="color:var(--primary)">1</span></span>
                <button onclick="openGrid()" style="background:var(--bg-card); border:1px solid var(--border); padding:8px 16px; border-radius:20px; color:var(--primary); font-weight:600; font-size:0.85rem; cursor:pointer;">
                    View Calendar <i class="fas fa-chevron-right" style="font-size:0.7em; margin-left:5px;"></i>
                </button>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                    <div>
                        <h2 style="margin:0; font-size:1.5rem; color:var(--text-main);" id="card-day">Day 1</h2>
                        <div id="card-date-display" style="font-size:0.9rem; color:var(--text-sub); margin-top:4px; font-weight:500;">Not Scheduled</div>
                    </div>
                    <div id="status-btn" onclick="toggleStatus()" style="width:48px; height:48px; border-radius:14px; border:2px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.3s; background:var(--bg-body);">
                        <i class="fas fa-check" style="color:white; display:none; font-size:1.4rem;"></i>
                    </div>
                </div>

                <div class="schedule-box">
                    <div class="schedule-group">
                        <label class="schedule-label"><i class="far fa-calendar-alt"></i> Plan Date</label>
                        <input type="date" id="input-date" class="schedule-input" onchange="saveSchedule()">
                    </div>
                    <div class="schedule-group">
                        <label class="schedule-label"><i class="far fa-clock"></i> Start Time</label>
                        <input type="time" id="input-time-sch" class="schedule-input" onchange="saveSchedule()">
                    </div>
                </div>

                <div class="section-header-row">
                    <div class="section-header">
                        <i class="fas fa-tasks"></i> Target List
                    </div>
                    <button class="btn-add-target" onclick="addTargetPrompt()">
                        <i class="fas fa-plus"></i> Add Target
                    </button>
                </div>
                
                <div id="targets-container" class="target-list">
                    </div>
                
                <div id="empty-targets-msg" style="text-align:center; padding:20px; font-size:0.9rem; color:var(--text-sub); font-style:italic; display:none;">
                    No targets added yet. Click "Add Target" to begin.
                </div>

                <div style="margin-top:25px;">
                    <label class="schedule-label">My Observations</label>
                    <textarea id="card-notes" style="width:100%; background:var(--bg-body); border:1px solid var(--border); padding:16px; border-radius:16px; resize:none; min-height:120px; font-family:inherit; color:var(--text-main); line-height:1.5; font-size:0.95rem;" placeholder="Add key points, formulas, or reminders here..." oninput="saveNotes()"></textarea>
                </div>
            </div>
        </div>

        <div id="view-list" style="display:none;">
            <div id="list-container"></div>
            <div onclick="addNewDay()" class="list-item" style="justify-content:center; color:var(--primary); font-weight:700; border-style:dashed;">
                <i class="fas fa-plus-circle"></i> Add New Day
            </div>
        </div>

        <div id="view-analytics" style="display:none;">
            <h3 style="margin-top:0; font-size:1.4rem;">Performance Report</h3>
            
            <div class="card">
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-val" style="color:var(--success)" id="stat-completed">0</div>
                        <div class="stat-lbl">Completed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" style="color:var(--warning)" id="stat-scheduled">0</div>
                        <div class="stat-lbl">Scheduled</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" style="color:var(--text-sub)" id="stat-pending">100</div>
                        <div class="stat-lbl">Pending</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" style="color:var(--primary)" id="stat-pct">0%</div>
                        <div class="stat-lbl">Progress</div>
                    </div>
                </div>

                <div style="height:250px; position:relative; width:100%;">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <button onclick="downloadPDF()" style="width:100%; padding:18px; background:var(--primary); border:none; color:white; border-radius:16px; font-weight:700; margin-bottom:24px; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); cursor:pointer;">
                <i class="fas fa-file-pdf"></i> Download Full Report
            </button>

            <div class="card data-console">
                <div class="console-header">
                    <i class="fas fa-terminal"></i>
                    <h3 style="margin:0; font-size:1.1rem;">Data Management Console</h3>
                </div>
                <div style="margin-bottom:15px; font-size:0.85rem; color:#94a3b8;">
                    Securely backup your progress or restore from a previous file.
                </div>
                
                <button onclick="exportData()" class="console-btn btn-backup">
                    <i class="fas fa-cloud-download-alt"></i> Backup Data (JSON)
                </button>
                
                <button onclick="document.getElementById('import-file').click()" class="console-btn btn-import">
                    <i class="fas fa-cloud-upload-alt"></i> Import Data
                </button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(this)">
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="grid-modal" onclick="if(event.target===this) this.style.display='none'">
        <div class="card" style="width:90%; max-width:400px; max-height:80vh; margin:0; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Select Day</h3>
                <button onclick="document.getElementById('grid-modal').style.display='none'" style="border:none; background:none; font-size:1.2rem; color:var(--text-sub); cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="grid-container" id="day-grid"></div>
            <button class="add-day-btn" onclick="addNewDay(); document.getElementById('grid-modal').style.display='none'">
                <i class="fas fa-plus"></i> Add Next Day
            </button>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-btn active" onclick="nav('home', this)">
            <i class="fas fa-layer-group"></i> <span>Plan</span>
        </button>
        <button class="nav-btn" onclick="nav('list', this); renderList();">
            <i class="fas fa-list-check"></i> <span>List</span>
        </button>
        <button class="nav-btn" onclick="nav('analytics', this); renderStats();">
            <i class="fas fa-chart-pie"></i> <span>Report</span>
        </button>
    </nav>

<script>
    // --- 1. DATA PROCESSING ---
    // Defined syllabus days - FULLY POPULATED 100 DAY PLAN IN TAMIL
    const syllabusPlan = [
        {d:1, targets:["தமிழ்: 6-ம் வகுப்பு (இயல் 1 & 2)", "GS: இந்திய அரசியலமைப்பு - முகவுரை (10th/12th)", "கணிதம்: சுருக்குக (Simplification) - அடிப்படைகள்"]},
        {d:2, targets:["தமிழ்: 6-ம் வகுப்பு (இயல் 3 & 4)", "GS: குடியுரிமை & அடிப்படை உரிமைகள்", "கணிதம்: BODMAS விதிமுறைகள்"]},
        {d:3, targets:["தமிழ்: 6-ம் வகுப்பு (இயல் 5 & 6)", "GS: அரசு நெறிமுறைக் கோட்பாடுகள் & கடமைகள்", "கணிதம்: வர்க்கமூலம் & கனமூலம்"]},
        {d:4, targets:["தமிழ்: 6-ம் வகுப்பு (இயல் 7, 8 & 9)", "GS: மத்திய அரசு (குடியரசு தலைவர், பிரதமர்)", "கணிதம்: விழுக்காடு (Percentage) - அடிப்படைகள்"]},
        {d:5, targets:["தமிழ்: 6-ம் வகுப்பு - முழுத் திருப்புதல்", "GS: நாடாளுமன்றம் (Rajya Sabha, Lok Sabha)", "கணிதம்: விழுக்காடு - கணக்குகள்"]},
        {d:6, targets:["தமிழ்: 7-ம் வகுப்பு (இயல் 1 & 2)", "GS: மாநில அரசு (ஆளுநர், முதல்வர்)", "கணிதம்: மீ.பெ.வ & மீ.சி.ம (LCM & HCF) - Basics"]},
        {d:7, targets:["தமிழ்: 7-ம் வகுப்பு (இயல் 3 & 4)", "GS: இந்திய நீதித்துறை & உயர்நீதிமன்றம்", "கணிதம்: LCM & HCF - Advanced"]},
        {d:8, targets:["தமிழ்: 7-ம் வகுப்பு (இயல் 5 & 6)", "GS: உள்ளாட்சி அமைப்புகள் (Panchayat Raj)", "கணிதம்: விகிதம் மற்றும் விகிதாச்சாரம் (Ratio)"]},
        {d:9, targets:["தமிழ்: 7-ம் வகுப்பு (இயல் 7, 8 & 9)", "GS: மத்திய - மாநில உறவுகள்", "கணிதம்: விகிதம் - நாணய கணக்குகள்"]},
        {d:10, targets:["தமிழ்: 7-ம் வகுப்பு - முழுத் திருப்புதல்", "GS: தேர்தல் ஆணையம் & ஊழல் தடுப்பு", "கணிதம்: தனிவட்டி (Simple Interest)"]},
        {d:11, targets:["தமிழ்: 8-ம் வகுப்பு (இயல் 1 & 2)", "GS: வரலாறு - சிந்து சமவெளி நாகரிகம்", "கணிதம்: தனிவட்டி - கணக்குகள்"]},
        {d:12, targets:["தமிழ்: 8-ம் வகுப்பு (இயல் 3 & 4)", "GS: வரலாறு - குப்தர்கள்", "கணிதம்: கூட்டுவட்டி (Compound Interest)"]},
        {d:13, targets:["தமிழ்: 8-ம் வகுப்பு (இயல் 5 & 6)", "GS: வரலாறு - டெல்லி சுல்தான்கள்", "கணிதம்: SI vs CI வித்தியாசம்"]},
        {d:14, targets:["தமிழ்: 8-ம் வகுப்பு (இயல் 7, 8 & 9)", "GS: வரலாறு - முகலாயர்கள்", "கணிதம்: பரப்பளவு - சதுரம்/செவ்வகம்"]},
        {d:15, targets:["தமிழ்: 8-ம் வகுப்பு - முழுத் திருப்புதல்", "GS: வரலாறு - மராத்தியர்கள்", "கணிதம்: பரப்பளவு - முக்கோணம்/வட்டம்"]},
        {d:16, targets:["தமிழ்: 9-ம் வகுப்பு (இயல் 1 & 2)", "GS: வரலாறு - விஜயநகர & பாமினி அரசுகள்", "கணிதம்: கொள்ளளவு (Volume) - கனசதுரம்"]},
        {d:17, targets:["தமிழ்: 9-ம் வகுப்பு (இயல் 3 & 4)", "GS: வரலாறு - தென்னிந்திய வரலாறு", "கணிதம்: கொள்ளளவு - உருளை/கூம்பு (Cylinder/Cone)"]},
        {d:18, targets:["தமிழ்: 9-ம் வகுப்பு (இயல் 5 & 6)", "GS: Unit 8 - இந்தியப் பண்பாட்டின் இயல்புகள்", "கணிதம்: காலம் மற்றும் வேலை (Time & Work)"]},
        {d:19, targets:["தமிழ்: 9-ம் வகுப்பு (இயல் 7, 8 & 9)", "GS: Unit 8 - வேற்றுமையில் ஒற்றுமை", "கணிதம்: Time & Work - சங்கிலித் தொடர்"]},
        {d:20, targets:["தமிழ்: 9-ம் வகுப்பு - முழுத் திருப்புதல்", "GS: INM - தொடக்க கால கிளர்ச்சிகள்", "கணிதம்: குழாய் கணக்குகள் (Pipes & Cisterns)"]},
        {d:21, targets:["தமிழ்: 10-ம் வகுப்பு (இயல் 1 & 2)", "GS: INM - பாளையக்காரர்கள் & வேலூர் கலகம்", "கணிதம்: தர்க்கக் காரணவியல் (Reasoning)"]},
        {d:22, targets:["தமிழ்: 10-ம் வகுப்பு (இயல் 3 & 4)", "GS: INM - 1857 பெரும் புரட்சி", "கணிதம்: எண் வரிசை (Number Series)"]},
        {d:23, targets:["தமிழ்: 10-ம் வகுப்பு (இயல் 5 & 6)", "GS: INM - காங்கிரஸ் உருவாக்கம் & மிதவாதிகள்", "கணிதம்: எழுத்து வரிசை (Alphabet Series)"]},
        {d:24, targets:["தமிழ்: 10-ம் வகுப்பு (இயல் 7, 8 & 9)", "GS: INM - தீவிரவாதிகள் & வ.உ.சி/பாரதி", "கணிதம்: விடுபட்ட எண் (Missing Numbers)"]},
        {d:25, targets:["தமிழ்: 10-ம் வகுப்பு - முழுத் திருப்புதல்", "GS: INM - காந்தியடிகள் சகாப்தம்", "கணிதம்: பகடை (Dice)"]},
        {d:26, targets:["தமிழ்: 11-ம் வகுப்பு (இயல் 1 & 3 செய்யுள்)", "GS: INM - வகுப்புவாதம் & தேசப்பிரிவினை", "கணிதம்: காட்சிக் காரணவியல் (Visual Reasoning)"]},
        {d:27, targets:["தமிழ்: 11-ம் வகுப்பு (இயல் 4 & 5 செய்யுள்)", "GS: Unit 8 - விடுதலைப் போரில் தமிழ்நாடு", "கணிதம்: புதிர்கள் (Puzzles)"]},
        {d:28, targets:["தமிழ்: 11-ம் வகுப்பு (இயல் 6-8 செய்யுள்)", "GS: Unit 8 - தமிழ்நாட்டில் சமூக மாற்றங்கள்", "கணிதம்: புள்ளியியல் (Statistics)"]},
        {d:29, targets:["தமிழ்: 12-ம் வகுப்பு (இயல் 1 & 2)", "GS: Unit 8 - நீதிக்கட்சி & சுயமரியாதை", "கணிதம்: நிகழ்தகவு (Probability)"]},
        {d:30, targets:["தமிழ்: 12-ம் வகுப்பு (இயல் 3 & 4)", "GS: Unit 8 - பெரியார் & அண்ணா", "கணிதம்: கணிதம் திருப்புதல் (PYQ)"]},
        {d:31, targets:["தமிழ்: 12-ம் வகுப்பு (இயல் 5 & 6)", "GS: Unit 9 - தமிழகத்தில் மனிதவள மேம்பாடு", "கணிதம்: சுருக்குக - பயிற்சி"]},
        {d:32, targets:["தமிழ்: 12-ம் வகுப்பு (இயல் 7 & 8)", "GS: Unit 9 - இடஒதுக்கீடு கொள்கை", "கணிதம்: விழுக்காடு - பயிற்சி"]},
        {d:33, targets:["தமிழ்: இலக்கணம் - எழுத்து & சொல்", "GS: Unit 9 - அரசியல் கட்சிகள் & நலத்திட்டங்கள்", "கணிதம்: LCM/HCF - பயிற்சி"]},
        {d:34, targets:["தமிழ்: இலக்கணம் - பொருள் & யாப்பு", "GS: Unit 9 - தமிழக புவியியல் கூறுகள்", "கணிதம்: விகிதம் - பயிற்சி"]},
        {d:35, targets:["தமிழ்: இலக்கணம் - அணி", "GS: Unit 9 - மின்னாளுகை (E-Governance)", "கணிதம்: தனிவட்டி/கூட்டுவட்டி - பயிற்சி"]},
        {d:36, targets:["தமிழ்: திருக்குறள் - அறத்துப்பால்", "GS: பொருளாதாரம் - ஐந்தாண்டு திட்டங்கள்", "கணிதம்: அளவியல் - பயிற்சி"]},
        {d:37, targets:["தமிழ்: திருக்குறள் - பொருட்பால்", "GS: பொருளாதாரம் - ரிசர்வ் வங்கி (RBI)", "கணிதம்: காலம் மற்றும் வேலை - பயிற்சி"]},
        {d:38, targets:["தமிழ்: நாலடியார் முதல் ஏலாதி வரை", "GS: பொருளாதாரம் - நிதி ஆணையம் & GST", "கணிதம்: ரீசனிங் - பயிற்சி"]},
        {d:39, targets:["தமிழ்: கம்பராமாயணம் / பெரியபுராணம்", "GS: புவியியல் - இந்தியா அமைவிடம்", "கணிதம்: முழுத் தேர்வு 1"]},
        {d:40, targets:["தமிழ்: சிற்றிலக்கியங்கள்", "GS: புவியியல் - பருவமழை & காலநிலை", "கணிதம்: முழுத் தேர்வு 2"]},
        {d:41, targets:["தமிழ்: மனோன்மணியம் / பாஞ்சாலி சபதம்", "GS: புவியியல் - வேளாண்மை & மண்", "கணிதம்: முழுத் தேர்வு 3"]},
        {d:42, targets:["தமிழ்: பாரதியார் & பாரதிதாசன்", "GS: புவியியல் - கனிம வளங்கள்", "கணிதம்: தவறுகளை திருத்துதல் (Analysis)"]},
        {d:43, targets:["தமிழ்: நாமக்கல் கவிஞர் / கவிமணி", "GS: புவியியல் - போக்குவரத்து", "கணிதம்: ஷார்ட்கட் பயிற்சி"]},
        {d:44, targets:["தமிழ்: புதுக்கவிதை & மரபுக்கவிதை", "GS: அறிவியல் - இயற்பியல் (விசை/இயக்கம்)", "கணிதம்: ஃபார்முலா திருப்புதல்"]},
        {d:45, targets:["தமிழ்: நாடகம் & கலைகள்", "GS: அறிவியல் - வேதியியல் (அமிலம்/உப்பு)", "கணிதம்: PYQ 2022 தாள்"]},
        {d:46, targets:["தமிழ்: திருப்புதல் - இலக்கணம் முழுவதும்", "GS: அறிவியல் - உயிரியல் (நோய்கள்)", "கணிதம்: PYQ 2024 தாள்"]},
        {d:47, targets:["தமிழ்: திருப்புதல் - இலக்கியம் முழுவதும்", "GS: நடப்பு நிகழ்வுகள் - மாதம் 1 & 2", "கணிதம்: மாதிரித் தேர்வு - கணிதம்"]},
        {d:48, targets:["தமிழ்: திருப்புதல் - தமிழ் அறிஞர்கள்", "GS: நடப்பு நிகழ்வுகள் - மாதம் 3 & 4", "கணிதம்: மாதிரித் தேர்வு - கணிதம்"]},
        {d:49, targets:["தமிழ்: முழு மாதிரித் தேர்வு (100 Q)", "GS: நடப்பு நிகழ்வுகள் - மாதம் 5 & 6", "கணிதம்: மாதிரித் தேர்வு - கணிதம்"]},
        {d:50, targets:["தமிழ்: பழைய புத்தகங்கள் (முக்கியவை)", "GS: முழு மாதிரித் தேர்வு (75 Q)", "கணிதம்: இறுதி ஃபார்முலா பார்வை"]},
        {d:51, targets:["தமிழ்: 6-ம் வகுப்பு Term 1 திருப்புதல்", "GS: Polity - முகவுரை/உரிமைகள் திருப்புதல்", "கணிதம்: சுருக்குக பயிற்சி"]},
        {d:52, targets:["தமிழ்: 6-ம் வகுப்பு Term 2 திருப்புதல்", "GS: Polity - கடமைகள் திருப்புதல்", "கணிதம்: விழுக்காடு பயிற்சி"]},
        {d:53, targets:["தமிழ்: 6-ம் வகுப்பு Term 3 திருப்புதல்", "GS: Polity - நாடாளுமன்றம் திருப்புதல்", "கணிதம்: LCM/HCF பயிற்சி"]},
        {d:54, targets:["தமிழ்: 7-ம் வகுப்பு Term 1 திருப்புதல்", "GS: வரலாறு - சிந்து சமவெளி திருப்புதல்", "கணிதம்: விகிதம் பயிற்சி"]},
        {d:55, targets:["தமிழ்: 7-ம் வகுப்பு Term 2 திருப்புதல்", "GS: வரலாறு - குப்தர்கள் திருப்புதல்", "கணிதம்: SI/CI பயிற்சி"]},
        {d:56, targets:["தமிழ்: 7-ம் வகுப்பு Term 3 திருப்புதல்", "GS: வரலாறு - டெல்லி சுல்தான்கள் திருப்புதல்", "கணிதம்: பரப்பளவு பயிற்சி"]},
        {d:57, targets:["தமிழ்: 8-ம் வகுப்பு Term 1 திருப்புதல்", "GS: வரலாறு - முகலாயர்கள் திருப்புதல்", "கணிதம்: கொள்ளளவு பயிற்சி"]},
        {d:58, targets:["தமிழ்: 8-ம் வகுப்பு Term 2 திருப்புதல்", "GS: INM - 1857 புரட்சி திருப்புதல்", "கணிதம்: Time & Work பயிற்சி"]},
        {d:59, targets:["தமிழ்: 8-ம் வகுப்பு Term 3 திருப்புதல்", "GS: INM - காங்கிரஸ் திருப்புதல்", "கணிதம்: Reasoning பயிற்சி"]},
        {d:60, targets:["தமிழ்: 9-ம் வகுப்பு Term 1 திருப்புதல்", "GS: INM - காந்தி சகாப்தம் திருப்புதல்", "கணிதம்: முழுத் தேர்வு 4"]},
        {d:61, targets:["தமிழ்: 9-ம் வகுப்பு Term 2 திருப்புதல்", "GS: Unit 8 - தமிழ் சமூகம் திருப்புதல்", "கணிதம்: முழுத் தேர்வு 5"]},
        {d:62, targets:["தமிழ்: 9-ம் வகுப்பு Term 3 திருப்புதல்", "GS: Unit 8 - நீதிக்கட்சி திருப்புதல்", "கணிதம்: பலவீனமான பகுதி பயிற்சி"]},
        {d:63, targets:["தமிழ்: 10-ம் வகுப்பு இயல் 1-3", "GS: Unit 9 - மனித வளம் திருப்புதல்", "கணிதம்: PYQ 2019 தாள்"]},
        {d:64, targets:["தமிழ்: 10-ம் வகுப்பு இயல் 4-6", "GS: Unit 9 - இடஒதுக்கீடு திருப்புதல்", "கணிதம்: PYQ 2018 தாள்"]},
        {d:65, targets:["தமிழ்: 10-ம் வகுப்பு இயல் 7-9", "GS: Eco - திட்டங்கள் திருப்புதல்", "கணிதம்: PYQ 2017 தாள்"]},
        {d:66, targets:["தமிழ்: 11-ம் வகுப்பு செய்யுள்", "GS: Eco - வங்கித்துறை திருப்புதல்", "கணிதம்: ஃபார்முலா பயிற்சி"]},
        {d:67, targets:["தமிழ்: 12-ம் வகுப்பு செய்யுள்", "GS: Geo - இந்தியா புவியியல்", "கணிதம்: வேகப் பயிற்சி (Speed Test)"]},
        {d:68, targets:["தமிழ்: இலக்கணம் - அகத்திணை", "GS: Geo - தமிழ்நாடு புவியியல்", "கணிதம்: வேகப் பயிற்சி"]},
        {d:69, targets:["தமிழ்: இலக்கணம் - புறத்திணை", "GS: அறிவியல் - தாவரவியல்", "கணிதம்: வேகப் பயிற்சி"]},
        {d:70, targets:["தமிழ்: இலக்கணம் - யாப்பு/அணி", "GS: அறிவியல் - விலங்கியல்", "கணிதம்: முழு மாதிரித் தேர்வு"]},
        {d:71, targets:["தமிழ்: பழைய புத்தகம் - 9th செய்யுள்", "GS: CA - மாதம் 1 திருப்புதல்", "கணிதம்: சுருக்குக (Advanced)"]},
        {d:72, targets:["தமிழ்: பழைய புத்தகம் - 10th செய்யுள்", "GS: CA - மாதம் 2 திருப்புதல்", "கணிதம்: விழுக்காடு (Advanced)"]},
        {d:73, targets:["தமிழ்: எதிர்ச்சொல் / பிழை திருத்தம்", "GS: CA - மாதம் 3 திருப்புதல்", "கணிதம்: LCM/HCF (Advanced)"]},
        {d:74, targets:["தமிழ்: ஒரு பொருள் பன்மொழி", "GS: CA - மாதம் 4 திருப்புதல்", "கணிதம்: விகிதம் (Advanced)"]},
        {d:75, targets:["தமிழ்: வேர்ச்சொல் / வினையெச்சம்", "GS: CA - மாதம் 5 திருப்புதல்", "கணிதம்: SI/CI (Advanced)"]},
        {d:76, targets:["தமிழ்: அகரவரிசை", "GS: CA - மாதம் 6 திருப்புதல்", "கணிதம்: அளவியல் (Advanced)"]},
        {d:77, targets:["தமிழ்: பெயர்ச்சொல் வகை", "GS: Polity - சட்டத் திருத்தங்கள்", "கணிதம்: Time & Work (Advanced)"]},
        {d:78, targets:["தமிழ்: இலக்கணக் குறிப்பு", "GS: Polity - அட்டவணைகள்", "கணிதம்: Reasoning (Advanced)"]},
        {d:79, targets:["தமிழ்: உவமையால் விளங்கும் பொருள்", "GS: History - கலை & கட்டிடக்கலை", "கணிதம்: முழுத் தேர்வு 6"]},
        {d:80, targets:["தமிழ்: நூல் & நூலாசிரியர்", "GS: INM - முக்கிய தலைவர்கள்", "கணிதம்: முழுத் தேர்வு 7"]},
        {d:81, targets:["தமிழ்: 6-12th திருக்குறள் முழுவதும்", "GS: Unit 8 - திருக்குறள் முழுவதும்", "கணிதம்: பலவீனமான பகுதி"]},
        {d:82, targets:["தமிழ்: 6-12th அறநூல்கள்", "GS: Unit 9 - நலத்திட்டங்கள்", "கணிதம்: பலவீனமான பகுதி"]},
        {d:83, targets:["தமிழ்: 6-12th காப்பியங்கள்", "GS: Eco - பட்ஜெட் / பொருளாதாரம்", "கணிதம்: பலவீனமான பகுதி"]},
        {d:84, targets:["தமிழ்: 6-12th சிற்றிலக்கியங்கள்", "GS: Geo - மக்கள் தொகை 2011", "கணிதம்: பலவீனமான பகுதி"]},
        {d:85, targets:["தமிழ்: 6-12th உரைநடை", "GS: Science - விதிகள் / கண்டுபிடிப்பு", "கணிதம்: முழு மாதிரித் தேர்வு"]},
        {d:86, targets:["தமிழ்: 6-12th துணைப்பாடம்", "GS: முழு சிலபஸ் தேர்வு 1", "கணிதம்: முழு மாதிரித் தேர்வு"]},
        {d:87, targets:["தமிழ்: பழைய வினாத்தாள் (2023)", "GS: முழு சிலபஸ் தேர்வு 2", "கணிதம்: முழு மாதிரித் தேர்வு"]},
        {d:88, targets:["தமிழ்: பழைய வினாத்தாள் (2022)", "GS: முழு சிலபஸ் தேர்வு 3", "கணிதம்: முழு மாதிரித் தேர்வு"]},
        {d:89, targets:["தமிழ்: பழைய வினாத்தாள் (2021)", "GS: முழு சிலபஸ் தேர்வு 4", "கணிதம்: முழு மாதிரித் தேர்வு"]},
        {d:90, targets:["தமிழ்: மாதிரித் தேர்வு 1 (100 Q)", "GS: மாதிரித் தேர்வு 1 (75 Q)", "கணிதம்: மாதிரித் தேர்வு 1 (25Q)"]},
        {d:91, targets:["தமிழ்: மாதிரித் தேர்வு 1 அலசல்", "GS: மாதிரித் தேர்வு 1 அலசல்", "கணிதம்: மாதிரித் தேர்வு 1 அலசல்"]},
        {d:92, targets:["தமிழ்: மாதிரித் தேர்வு 2 (100 Q)", "GS: மாதிரித் தேர்வு 2 (75 Q)", "கணிதம்: மாதிரித் தேர்வு 2 (25Q)"]},
        {d:93, targets:["தமிழ்: மாதிரித் தேர்வு 2 அலசல்", "GS: மாதிரித் தேர்வு 2 அலசல்", "கணிதம்: மாதிரித் தேர்வு 2 அலசல்"]},
        {d:94, targets:["தமிழ்: மாதிரித் தேர்வு 3 (100 Q)", "GS: மாதிரித் தேர்வு 3 (75 Q)", "கணிதம்: மாதிரித் தேர்வு 3 (25Q)"]},
        {d:95, targets:["தமிழ்: மாதிரித் தேர்வு 3 அலசல்", "GS: மாதிரித் தேர்வு 3 அலசல்", "கணிதம்: மாதிரித் தேர்வு 3 அலசல்"]},
        {d:96, targets:["தமிழ்: துரித திருப்புதல் - இலக்கணம்", "GS: துரித திருப்புதல் - Polity", "கணிதம்: ஃபார்முலா தாள்"]},
        {d:97, targets:["தமிழ்: துரித திருப்புதல் - இலக்கியம்", "GS: துரித திருப்புதல் - History/INM", "கணிதம்: ஃபார்முலா தாள்"]},
        {d:98, targets:["தமிழ்: துரித திருப்புதல் - அறிஞர்கள்", "GS: துரித திருப்புதல் - Unit 8/9", "கணிதம்: ஓய்வு / லேசான படிப்பு"]},
        {d:99, targets:["தமிழ்: இறுதிப் பார்வை - ஆசிரியர்கள்", "GS: இறுதிப் பார்வை - CA", "கணிதம்: ஓய்வு"]},
        {d:100, targets:["ஓய்வு - படிப்பு வேண்டாம்", "ஹால் டிக்கெட் / ஐடி சரிபார்", "சீக்கிரம் தூங்குங்கள்"]}
    ];

    // --- 2. INIT ---
    // v4 DB - clean slate forced by new key
    let db = JSON.parse(localStorage.getItem('kk_analytics_db_v4')) || {
        tasks: syllabusPlan.map(t => ({...t, done: false, notes: "", scheduledDate: "", scheduledTime: ""})),
        theme: 'light'
    };

    let currentDay = 1;
    let timerInterval = null;
    let timerSeconds = 0; // Starts at 0 now
    let chartInstance = null;

    function init() {
        if(db.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
        const firstUndone = db.tasks.find(t => !t.done);
        if(firstUndone) currentDay = firstUndone.d;
        renderHome();
    }

    // --- 3. HOME LOGIC ---
    function renderHome() {
        const task = db.tasks.find(t => t.d === currentDay);
        if(!task) return;

        document.getElementById('current-day-num').innerText = currentDay;
        document.getElementById('card-day').innerText = `Day ${task.d}`;
        document.getElementById('card-notes').value = task.notes || "";
        
        document.getElementById('input-date').value = task.scheduledDate || "";
        document.getElementById('input-time-sch').value = task.scheduledTime || "";
        
        const dateDisp = document.getElementById('card-date-display');
        if(task.scheduledDate) {
            const dateObj = new Date(task.scheduledDate);
            const dateStr = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', weekday: 'short' });
            dateDisp.innerText = `Scheduled: ${dateStr} ${task.scheduledTime ? '@ '+task.scheduledTime : ''}`;
            dateDisp.style.color = "var(--primary)";
        } else {
            dateDisp.innerText = "Not Scheduled";
            dateDisp.style.color = "var(--text-sub)";
        }

        const btn = document.getElementById('status-btn');
        const icon = btn.querySelector('i');
        if(task.done) {
            btn.style.background = 'var(--success)';
            btn.style.borderColor = 'var(--success)';
            icon.style.display = 'block';
        } else {
            btn.style.background = 'var(--bg-body)';
            btn.style.borderColor = 'var(--border)';
            icon.style.display = 'none';
        }

        renderTargets(task);
    }

    function renderTargets(task) {
        const container = document.getElementById('targets-container');
        const msg = document.getElementById('empty-targets-msg');
        container.innerHTML = '';

        if(!task.targets || task.targets.length === 0) {
            msg.style.display = 'block';
        } else {
            msg.style.display = 'none';
            task.targets.forEach((targetText, index) => {
                const div = document.createElement('div');
                div.className = 'target-item';
                div.innerHTML = `
                    <div class="target-bullet"></div>
                    <div class="target-text">${targetText}</div>
                    <div class="target-delete" onclick="deleteTarget(${index})"><i class="fas fa-times"></i></div>
                `;
                container.appendChild(div);
            });
        }
    }

    function addTargetPrompt() {
        const text = prompt("Enter new target description:");
        if(text && text.trim() !== "") {
            const task = db.tasks.find(t => t.d === currentDay);
            if(!task.targets) task.targets = [];
            task.targets.push(text.trim());
            save();
            renderHome();
        }
    }

    function deleteTarget(index) {
        if(confirm("Remove this target?")) {
            const task = db.tasks.find(t => t.d === currentDay);
            task.targets.splice(index, 1);
            save();
            renderHome();
        }
    }

    function addNewDay() {
        const maxDay = db.tasks.length > 0 ? Math.max(...db.tasks.map(t => t.d)) : 0;
        const newDayNum = maxDay + 1;
        db.tasks.push({
            d: newDayNum,
            targets: [],
            done: false,
            notes: "",
            scheduledDate: "",
            scheduledTime: ""
        });
        save();
        currentDay = newDayNum;
        renderHome();
        // If in list view, re-render list
        if(document.getElementById('view-list').style.display === 'block') {
            renderList();
        }
    }

    function saveSchedule() {
        const task = db.tasks.find(t => t.d === currentDay);
        task.scheduledDate = document.getElementById('input-date').value;
        task.scheduledTime = document.getElementById('input-time-sch').value;
        save();
        renderHome();
    }

    function saveNotes() {
        const task = db.tasks.find(t => t.d === currentDay);
        task.notes = document.getElementById('card-notes').value;
        save();
    }

    function toggleStatus() {
        const task = db.tasks.find(t => t.d === currentDay);
        task.done = !task.done;
        save();
        renderHome();
    }

    // --- 4. TIMER (STOPWATCH MODE) ---
    function startTimer() {
        if(timerInterval) return;
        document.getElementById('btn-start').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('btn-start').style.opacity = "0.5";
        timerInterval = setInterval(() => {
            timerSeconds++; // Increment now
            updateTimerDisplay();
        }, 1000);
    }
    function pauseTimer() { 
        clearInterval(timerInterval); 
        timerInterval=null; 
        document.getElementById('btn-start').style.opacity = "1";
    }
    function resetTimer() { 
        pauseTimer(); 
        timerSeconds=0; // Reset to 0
        updateTimerDisplay(); 
    }
    function updateTimerDisplay() {
        const h = Math.floor(timerSeconds/3600).toString().padStart(2,'0');
        const m = Math.floor((timerSeconds%3600)/60).toString().padStart(2,'0');
        const s = (timerSeconds%60).toString().padStart(2,'0');
        document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
    }

    // --- 5. ANALYTICS & CONSOLE ---
    function renderStats() {
        const completed = db.tasks.filter(t=>t.done).length;
        const scheduled = db.tasks.filter(t=>t.scheduledDate && !t.done).length;
        const pending = db.tasks.length - completed;
        const pct = db.tasks.length > 0 ? Math.round((completed / db.tasks.length) * 100) : 0;

        document.getElementById('stat-completed').innerText = completed;
        document.getElementById('stat-scheduled').innerText = scheduled;
        document.getElementById('stat-pending').innerText = pending;
        document.getElementById('stat-pct').innerText = `${pct}%`;

        // Chart
        const ctx = document.getElementById('progressChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Scheduled', 'Pending'],
                datasets: [{
                    data: [completed, scheduled, pending - scheduled],
                    backgroundColor: ['#10b981', '#f59e0b', '#e2e8f0'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, font: {family: "'Outfit'"} } }
                },
                cutout: '75%'
            }
        });
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(79, 70, 229);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.text("TNPSC Study Report", 14, 20);
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 190, 20, {align:'right'});

        const doneCount = db.tasks.filter(t=>t.done).length;
        const pct = db.tasks.length > 0 ? Math.round((doneCount / db.tasks.length) * 100) : 0;
        
        doc.setTextColor(0, 0, 0);
        doc.text(`Progress: ${pct}%`, 14, 40);
        
        const rows = db.tasks.map(t => [
            t.d,
            t.scheduledDate ? t.scheduledDate : '-',
            (t.targets || []).join("\n"), // Join dynamic targets with newlines
            t.done ? 'DONE' : 'PENDING',
            t.notes || '-'
        ]);

        doc.autoTable({
            startY: 45,
            head: [['Day', 'Date', 'Targets', 'Status', 'Notes']],
            body: rows,
            theme: 'grid',
            headStyles: { fillColor: [79, 70, 229] },
            styles: { fontSize: 8, cellPadding: 3, valign: 'middle' },
            columnStyles: { 
                0: {cellWidth: 10}, 
                1: {cellWidth: 20},
                2: {cellWidth: 70},
                3: {cellWidth: 20, fontStyle: 'bold'},
                4: {cellWidth: 60}
            },
            didParseCell: function(data) {
                if (data.column.index === 3 && data.cell.raw === 'DONE') {
                    data.cell.styles.textColor = [16, 185, 129];
                }
            }
        });
        doc.save('TNPSC_Progress_Report.pdf');
    }

    // --- DATA CONSOLE FUNCTIONS ---
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "tnpsc_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedDb = JSON.parse(e.target.result);
                if(importedDb.tasks && Array.isArray(importedDb.tasks)) {
                    if(confirm("Restore data from this file? This will overwrite current progress.")) {
                        db = importedDb;
                        save();
                        location.reload();
                    }
                } else {
                    alert("Invalid backup file format.");
                }
            } catch(err) {
                alert("Error reading file: " + err);
            }
        };
        reader.readAsText(file);
    }

    // --- 6. LIST & SEARCH ---
    function renderList(data = db.tasks) {
        const list = document.getElementById('list-container');
        list.innerHTML = '';
        data.forEach(t => {
            const dateStr = t.scheduledDate ? new Date(t.scheduledDate).toLocaleDateString() : '';
            const targetSummary = (t.targets && t.targets.length > 0) ? t.targets[0] : "No targets";
            
            const el = document.createElement('div');
            el.className = 'list-item';
            el.onclick = () => { currentDay=t.d; nav('home', document.querySelectorAll('.nav-btn')[0]); renderHome(); };
            el.innerHTML = `
                <div style="font-weight:800; color:var(--primary); width:35px; font-size:1.1rem;">${t.d}</div>
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:0.9rem; margin-bottom:4px;">${targetSummary.substring(0,40)}${targetSummary.length>40?'...':''}</div>
                    <div style="font-size:0.75rem; color:var(--text-sub);">
                        ${dateStr ? `<i class="far fa-calendar"></i> ${dateStr}` : 'Not Scheduled'} 
                        ${t.targets ? `• ${t.targets.length} Targets` : ''}
                        ${t.done ? '• <span style="color:var(--success); font-weight:700;">Completed</span>' : ''}
                    </div>
                </div>
                ${t.done ? '<i class="fas fa-check-circle" style="color:var(--success); font-size:1.2rem;"></i>' : '<i class="far fa-circle" style="color:var(--border); font-size:1.2rem;"></i>'}
            `;
            list.appendChild(el);
        });
    }

    function handleSearch(q) {
        if(!q) { if(document.getElementById('view-list').style.display !== 'none') renderList(); return; }
        nav('list', document.querySelectorAll('.nav-btn')[1]);
        const res = db.tasks.filter(t => JSON.stringify(t).toLowerCase().includes(q.toLowerCase()));
        renderList(res);
    }

    function openGrid() {
        const grid = document.getElementById('day-grid');
        grid.innerHTML = '';
        db.tasks.forEach(t => {
            const el = document.createElement('div');
            el.className = `grid-item ${t.d===currentDay?'active':''} ${t.done?'done':''} ${t.scheduledDate?'scheduled':''}`;
            el.innerText = t.d;
            el.onclick = () => { currentDay=t.d; renderHome(); document.getElementById('grid-modal').style.display='none'; };
            grid.appendChild(el);
        });
        document.getElementById('grid-modal').style.display='flex';
    }

    // --- UTILS ---
    function nav(view, btn) {
        ['home','list','analytics'].forEach(v=>document.getElementById(`view-${v}`).style.display='none');
        document.getElementById(`view-${view}`).style.display='block';
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        db.theme = isDark ? 'light' : 'dark';
        save();
    }

    function save() { localStorage.setItem('kk_analytics_db_v4', JSON.stringify(db)); }
    
    init();
</script>
</body>
  </html>
